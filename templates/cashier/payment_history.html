{% extends "base.html" %}

{% block title %}Payment History - Student Tuition Billing and Payment System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">Payment History</h1>
        <p class="text-muted">View and manage all payment transactions</p>
    </div>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
            <i class="bi bi-funnel me-2"></i>Filter
        </button>
        <button type="button" class="btn btn-secondary" onclick="printReport()">
            <i class="bi bi-printer me-2"></i>Print Report
        </button>
        <button type="button" class="btn btn-primary" onclick="exportToExcel()">
            <i class="bi bi-file-earmark-excel me-2"></i>Export Excel
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <div class="h4 mb-1">{{ summary.total_payments or 0}}</div>
                <div class="small text-uppercase fw-bold">Total Payments</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card-secondary">
            <div class="card-body text-center">
                <div class="h4 mb-1">₱{{ "{:,.2f}".format(summary.total_amount or 0.00) }}</div>
                <div class="small text-uppercase fw-bold">Total Amount</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <div class="h4 mb-1">₱{{ "{:,.2f}".format(summary.todays_total or 0.00) }}</div>
                <div class="small text-uppercase fw-bold">Today's Total</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card-secondary">
            <div class="card-body text-center">
                <div class="h4 mb-1">₱{{ "{:,.2f}".format(summary.monthly_total or 0.00) }}</div>
                <div class="small text-uppercase fw-bold">This Month</div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Filter Buttons -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all">
                        All Payments
                    </button>
                    <button type="button" class="btn btn-outline-success filter-btn" data-filter="today">
                        Today
                    </button>
                    <button type="button" class="btn btn-outline-info filter-btn" data-filter="week">
                        This Week
                    </button>
                    <button type="button" class="btn btn-outline-warning filter-btn" data-filter="month">
                        This Month
                    </button>
<!--                    <button type="button" class="btn btn-outline-secondary filter-btn" data-filter="pending">-->
<!--                        Pending-->
<!--                    </button>-->
                    <button type="button" class="btn btn-outline-danger filter-btn" data-filter="cash">
                        Cash Only
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment History Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-table me-2"></i>
                        Payment Records
                    </h5>
                    <div class="d-flex align-items-center gap-3">
                        <div class="input-group" style="width: 300px;">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search student, receipt...">
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <select class="form-select" id="recordsPerPage" style="width: auto;">
                            <option value="10">10 per page</option>
                            <option value="25" selected>25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 text-center align-middle" id="paymentTable">
                        <thead>
                            <tr>
<!--                                <th>Reference No.</th>-->
                                <th>Date & Time</th>
                                <th>Student</th>
                                <th>Course</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
<!--                                <th>Actions</th>-->
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payment_history %}
                            <tr class="payment-row"
                            data-date="{{ payment.datetime.strftime('%Y-%m-%d') }}"
                            data-method="{{ payment.method | lower }}"
                            data-status="{{ payment.status | lower }}">
<!--                                <td>-->
<!--                                    <strong class="text-primary">{{ payment.reference or "— —" }}</strong>-->
<!--                                </td>-->
                                <td>
                                    <div>{{ payment.datetime.strftime('%Y-%m-%d') }}    </div>
                                    <small class="text-muted">{{ payment.datetime.strftime('%H:%M:%S') }}</small>
                                </td>
                                <td>
                                    <div><strong>{{ payment.student }}</strong></div>
                                    <small class="text-muted">{{ payment.student_id }}</small>
                                </td>
                                <td>{{ payment.course or "— —"}}</td>
                                <td><strong>₱{{ "{:,.2f}".format(payment.amount) }}</strong></td>
                                <td>
                                    <span class="badge bg-light text-dark">
                                        {% if payment.method == 'Cash' %}
                                            <i class="bi bi-cash me-1"></i>
                                        {% elif payment.method == 'Bank Transfer' %}
                                            <i class="bi bi-bank me-1"></i>
                                        {% elif payment.method in ['GCash', 'PayMaya'] %}
                                            <i class="bi bi-phone me-1"></i>
                                        {% else %}
                                            <i class="bi bi-credit-card me-1"></i>
                                        {% endif %}
                                        {{ payment.method }}
                                    </span>
                                    {% if payment.reference %}
                                        <br><small class="text-muted">{{ payment.reference }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if payment.status == 'paid' %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>Paid
                                        </span>
                                    {% elif payment.status == 'partial' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-exclamation-triangle me-1"></i>Partially Paid
                                        </span>
                                    {% elif payment.status == 'unpaid' %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle me-1"></i>Unpaid
                                        </span>
                                    {% endif %}
                                </td>
<!--                                <td>-->
<!--                                    <div class="btn-group" role="group">-->
<!--                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewReceipt('{{ payment.receipt }}')">-->
<!--                                            <i class="bi bi-eye"></i>-->
<!--                                        </button>-->
<!--                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="printReceipt('{{ payment.receipt }}')">-->
<!--                                            <i class="bi bi-printer"></i>-->
<!--                                        </button>-->
<!--                                        {% if payment.status == 'pending' %}-->
<!--                                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="updatePaymentStatus('{{ payment.receipt }}', 'completed')">-->
<!--                                            <i class="bi bi-check"></i>-->
<!--                                        </button>-->
<!--                                        {% endif %}-->
<!--                                    </div>-->
<!--                                </td>-->
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted">
                        Showing <span id="showingStart">{{ offset + 1 }}</span>
                        to <span id="showingEnd">{{ showing_end }}</span>
                        of <span id="totalRecords">{{ total_records }}</span> payments
                    </div>
                    <nav>
                        <ul class="pagination">
                            {% set total_pages = (total_payments // per_page) + (1 if total_payments % per_page else 0) %}

                            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('cashier.payment_history_all', page=page-1, per_page=per_page) }}">Previous</a>
                            </li>

                            {% for p in range(1, total_pages + 1) %}
                                <li class="page-item {% if p == page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('cashier.payment_history_all', page=p, per_page=per_page) }}">{{ p }}</a>
                                </li>
                            {% endfor %}

                            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('cashier.payment_history_all', page=page+1, per_page=per_page) }}">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Advanced Filter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="filterForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date From</label>
                            <input type="date" class="form-control" id="dateFrom">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date To</label>
                            <input type="date" class="form-control" id="dateTo">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Payment Method</label>
                            <select class="form-select" id="paymentMethodFilter">
                                <option value="">All Methods</option>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="E-Wallet">E-Wallet</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="paid">Paid</option>
                                <option value="partial">Partially paid</option>
                                <option value="unpaid">Unpaid</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Min Amount</label>
                            <input type="number" class="form-control" id="minAmount" step="0.01">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Amount</label>
                            <input type="number" class="form-control" id="maxAmount" step="0.01">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Course</label>
                        <select class="form-select" id="courseFilter">
                            <option value="">All Courses</option>
                            {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear All</button>
                <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter buttons functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            filterPayments(this.dataset.filter);
        });
    });

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', function() {
        searchPayments(this.value);
    });
});

function filterPayments(filter) {
    const rows = document.querySelectorAll('#paymentTable tbody tr');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayStr = today.toLocaleDateString('en-CA'); // format: YYYY-MM-DD

    const weekAgo = new Date();
    weekAgo.setDate(today.getDate() - 7);
    const weekAgoStr = weekAgo.toLocaleDateString('en-CA');

    const monthAgo = new Date();
    monthAgo.setDate(today.getDate() - 30);
    const monthAgoStr = monthAgo.toLocaleDateString('en-CA');


    rows.forEach(row => {
        const status = row.dataset.status;
        const method = row.dataset.method;
        const date = row.dataset.date;
        let show = false;

        switch(filter) {
            case 'all':
                show = true;
                break;
            case 'today':
            show = date === todayStr;
            break;
        case 'week':
            show = date >= weekAgoStr;
            break;
        case 'month':
            show = date >= monthAgoStr;
            break;
            case 'pending':
                show = status === 'pending';
                break;
            case 'cash':
                show = method === 'cash';
                break;
        }

        row.style.display = show ? '' : 'none';
    });
}

function searchPayments(query) {
    const rows = document.querySelectorAll('#paymentTable tbody tr');
    const searchTerm = query.toLowerCase();

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function viewReceipt(receiptId) {
    alert(`Viewing receipt: ${receiptId}`);
    // Implementation for viewing receipt details
}

function printReceipt(receiptId) {
    alert(`Printing receipt: ${receiptId}`);
    // Implementation for printing receipt
}

function updatePaymentStatus(receiptId, newStatus) {
    if (confirm(`Are you sure you want to mark payment ${receiptId} as ${newStatus}?`)) {
        alert(`Payment ${receiptId} status updated to ${newStatus}`);
        // Implementation for updating payment status
        location.reload();
    }
}

function printReport() {
    window.print();
}

function exportToExcel() {
    window.location.href = "/cashier/export/payments";

}

function clearFilters() {
    document.getElementById('filterForm').reset();
    applyFilters();
}

function applyFilters() {
    // Get filter values
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const paymentMethod = document.getElementById('paymentMethodFilter').value;
    const status = document.getElementById('statusFilter').value;
    const minAmount = document.getElementById('minAmount').value;
    const maxAmount = document.getElementById('maxAmount').value;
    const course = document.getElementById('courseFilter').value;

    // Apply filters to table
    const rows = document.querySelectorAll('#paymentTable tbody tr');
    rows.forEach(row => {
        let show = true;
        const rowDate = row.dataset.date;
        const rowMethod = row.dataset.method;
        const rowStatus = row.dataset.status;
        const rowAmount = parseFloat(row.cells[4].textContent.replace(/[₱,]/g, ''));
        const rowCourse = row.cells[3].textContent;

        // Apply date filters
        if (dateFrom && rowDate < dateFrom) show = false;
        if (dateTo && rowDate > dateTo) show = false;
        
        // Apply other filters
        if (paymentMethod && rowMethod !== paymentMethod.toLowerCase()) show = false;
        if (status && rowStatus !== status.toLowerCase()) show = false;
        if (minAmount && rowAmount < parseFloat(minAmount)) show = false;
        if (maxAmount && rowAmount > parseFloat(maxAmount)) show = false;
        if (course && rowCourse.toLowerCase() !== course.toLowerCase()) show = false;

        row.style.display = show ? '' : 'none';
    });

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
    modal.hide();
}
</script>
{% endblock %}