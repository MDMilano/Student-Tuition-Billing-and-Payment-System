{% extends "base.html" %}

{% block title %}Profile - Student Tuition Billing and Payment System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">My Profile</h1>
                    <p class="text-muted">Manage your account information and preferences</p>
                </div>
            </div>

            <div class="row">
                <!-- Profile Information -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-person me-2"></i>
                                Personal Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="profileForm" method="POST" action="{{ url_for('cashier.update_profile') }}">
                                <div class="mb-3">
                                    <label for="fullName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="fullName" name="full_name"
                                           value="{{ current_user.name or '' }}" readonly required>
                                </div>

                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" name="email"
                                           value="{{ current_user.email or '' }}" readonly required>
                                </div>

                                <div class="mb-3">
                                    <label for="role" class="form-label">Role</label>
                                    <input type="text" class="form-control" id="role"
                                           value="{{ current_user.role.title() if current_user.role else 'Cashier' }}" readonly>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-primary" onclick="toggleEditMode()">
                                        <i class="bi bi-pencil me-2"></i>Edit Profile
                                    </button>
                                </div>

                                <div class="d-none" id="editActions">
                                    <hr>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                                            <i class="bi bi-check me-2"></i>
                                            <span>Save Changes</span>
                                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </span>
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">
                                            <i class="bi bi-x me-2"></i>Cancel
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Change Password Section -->
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-lock me-2"></i>
                                Change Password
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="passwordForm" method="POST" action="{{ url_for('cashier.change_password') }}">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">Current Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="currentPassword" name="current_password"
                                               placeholder="Enter your current password" required>
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('currentPassword')">
                                            <i class="bi bi-eye" id="currentPasswordIcon"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">New Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="newPassword" name="new_password"
                                               placeholder="Enter new password" required>
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('newPassword')">
                                            <i class="bi bi-eye" id="newPasswordIcon"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        Password must be at least 8 characters long and contain uppercase, lowercase, and number.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="confirmPassword" name="confirm_password"
                                               placeholder="Confirm new password" required>
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('confirmPassword')">
                                            <i class="bi bi-eye" id="confirmPasswordIcon"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="progress" style="height: 5px;">
                                        <div class="progress-bar" id="passwordStrength" style="width: 0%"></div>
                                    </div>
                                    <small class="form-text" id="passwordStrengthText">Password strength: Weak</small>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                                        <i class="bi bi-key me-2"></i>
                                        <span>Change Password</span>
                                        <span class="spinner-border spinner-border-sm ms-2 d-none" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </span>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearPasswordForm()">
                                        <i class="bi bi-arrow-clockwise me-2"></i>Reset Form
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Alert auto-dismiss animation - Removed since handled by base.html */

/* Full screen layout adjustments */
.container-fluid {
    padding: 0 15px;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

/* Password strength colors */
.bg-very-weak { background-color: #dc3545 !important; }
.bg-weak { background-color: #fd7e14 !important; }
.bg-medium { background-color: #ffc107 !important; }
.bg-strong { background-color: #20c997 !important; }
.bg-very-strong { background-color: #198754 !important; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize password strength checker
    const newPasswordField = document.getElementById('newPassword');
    if (newPasswordField) {
        newPasswordField.addEventListener('input', checkPasswordStrength);
    }

    // Handle form submissions
    setupFormHandlers();
});

// Flash messages are handled by base.html template

// Setup form submission handlers
function setupFormHandlers() {
    // Profile form handler
    const profileForm = document.getElementById('profileForm');
    if (profileForm) {
        profileForm.addEventListener('submit', function(e) {
            const saveBtn = document.getElementById('saveProfileBtn');
            const btnText = saveBtn.querySelector('span:first-of-type');
            const spinner = saveBtn.querySelector('.spinner-border');

            // Show loading state
            saveBtn.disabled = true;
            btnText.textContent = 'Saving...';
            spinner.classList.remove('d-none');
        });
    }

    // Password form handler with enhanced client-side validation
    const passwordForm = document.getElementById('passwordForm');
    if (passwordForm) {
        passwordForm.addEventListener('submit', function(e) {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Client-side validation with scroll to top for errors
            if (!currentPassword.trim()) {
                e.preventDefault();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            if (!newPassword.trim()) {
                e.preventDefault();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            if (newPassword !== confirmPassword) {
                e.preventDefault();
                document.getElementById('confirmPassword').focus();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            if (newPassword.length < 8) {
                e.preventDefault();
                document.getElementById('newPassword').focus();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            // Password strength validation
            const hasUpper = /[A-Z]/.test(newPassword);
            const hasLower = /[a-z]/.test(newPassword);
            const hasNumber = /\d/.test(newPassword);

            if (!hasUpper) {
                e.preventDefault();
                document.getElementById('newPassword').focus();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            if (!hasLower) {
                e.preventDefault();
                document.getElementById('newPassword').focus();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            if (!hasNumber) {
                e.preventDefault();
                document.getElementById('newPassword').focus();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            if (currentPassword === newPassword) {
                e.preventDefault();
                document.getElementById('newPassword').focus();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            const changeBtn = document.getElementById('changePasswordBtn');
            const btnText = changeBtn.querySelector('span:first-of-type');
            const spinner = changeBtn.querySelector('.spinner-border');

            // Show loading state
            changeBtn.disabled = true;
            btnText.textContent = 'Changing...';
            spinner.classList.remove('d-none');
        });
    }
}

function toggleEditMode() {
    const inputs = document.querySelectorAll('#profileForm input[type="text"], #profileForm input[type="email"]');
    const editActions = document.getElementById('editActions');
    const editButton = document.querySelector('button[onclick="toggleEditMode()"]');
    const roleField = document.getElementById('role');

    const isReadonly = inputs[0].hasAttribute('readonly');

    inputs.forEach(input => {
        if (input !== roleField) { // Keep role field readonly
            if (isReadonly) {
                input.removeAttribute('readonly');
                input.classList.add('border-primary');
            } else {
                input.setAttribute('readonly', true);
                input.classList.remove('border-primary');
            }
        }
    });

    if (isReadonly) {
        editActions.classList.remove('d-none');
        editButton.innerHTML = '<i class="bi bi-x me-2"></i>Cancel Edit';
        editButton.setAttribute('onclick', 'cancelEdit()');
        editButton.classList.remove('btn-outline-primary');
        editButton.classList.add('btn-outline-secondary');
    } else {
        editActions.classList.add('d-none');
        editButton.innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Profile';
        editButton.setAttribute('onclick', 'toggleEditMode()');
        editButton.classList.remove('btn-outline-secondary');
        editButton.classList.add('btn-outline-primary');
    }
}

function cancelEdit() {
    // Reset form to original values
    document.getElementById('fullName').value = "{{ current_user.name or '' }}";
    document.getElementById('email').value = "{{ current_user.email or '' }}";

    // Reset edit mode
    const inputs = document.querySelectorAll('#profileForm input[type="text"], #profileForm input[type="email"]');
    const editActions = document.getElementById('editActions');
    const editButton = document.querySelector('button[onclick="cancelEdit()"]');
    const roleField = document.getElementById('role');

    inputs.forEach(input => {
        if (input !== roleField) {
            input.setAttribute('readonly', true);
            input.classList.remove('border-primary');
        }
    });

    editActions.classList.add('d-none');
    editButton.innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Profile';
    editButton.setAttribute('onclick', 'toggleEditMode()');
    editButton.classList.remove('btn-outline-secondary');
    editButton.classList.add('btn-outline-primary');
}

function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + 'Icon');

    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

function checkPasswordStrength() {
    const password = document.getElementById('newPassword').value;
    const strengthBar = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('passwordStrengthText');

    let strength = 0;
    let label = 'Very Weak';
    let colorClass = 'bg-very-weak';

    // Length check
    if (password.length >= 8) strength += 20;
    if (password.length >= 12) strength += 5;

    // Character type checks
    if (/[a-z]/.test(password)) strength += 20;
    if (/[A-Z]/.test(password)) strength += 20;
    if (/[0-9]/.test(password)) strength += 20;
    if (/[^A-Za-z0-9]/.test(password)) strength += 15; // Special chars give bonus but not required

    // Complexity bonus
    const uniqueChars = new Set(password).size;
    if (uniqueChars >= 6) strength += 15;

    // Determine strength label and color
    if (strength >= 85) {
        label = 'Very Strong';
        colorClass = 'bg-very-strong';
    } else if (strength >= 70) {
        label = 'Strong';
        colorClass = 'bg-strong';
    } else if (strength >= 50) {
        label = 'Medium';
        colorClass = 'bg-medium';
    } else if (strength >= 25) {
        label = 'Weak';
        colorClass = 'bg-weak';
    }

    // Cap at 100%
    strength = Math.min(strength, 100);

    strengthBar.style.width = strength + '%';
    strengthBar.className = 'progress-bar ' + colorClass;
    strengthText.textContent = 'Password strength: ' + label;
}

function clearPasswordForm() {
    document.getElementById('passwordForm').reset();
    document.getElementById('passwordStrength').style.width = '0%';
    document.getElementById('passwordStrength').className = 'progress-bar bg-very-weak';
    document.getElementById('passwordStrengthText').textContent = 'Password strength: Very Weak';

    // Reset all password field types to password
    const passwordFields = ['currentPassword', 'newPassword', 'confirmPassword'];
    passwordFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const icon = document.getElementById(fieldId + 'Icon');
        if (field && icon) {
            field.type = 'password';
            icon.className = 'bi bi-eye';
        }
    });
}
</script>
{% endblock %}